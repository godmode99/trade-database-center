# รายงานประเมินโปรเจค Trade Database Center

## 1) สรุปเป้าหมายจากเอกสารโครงการ
โปรเจคมีเป้าหมายหลัก 3 ส่วน:
1. Fetch/แปลง/คำนวณข้อมูล แล้วบันทึกลงฐานข้อมูล
2. แสดงผลข้อมูลบนหน้าเว็บ
3. เป็นศูนย์กลางข้อมูลให้โปรเจคอื่นเรียกใช้งานต่อ

ข้อมูลที่ต้องรองรับมี 4 แหล่ง: FRED, MT5, CME FedWatch, Calendar พร้อมความถี่รายวัน/รายสัปดาห์/รายเดือนตามรายการในเอกสารโครงการ

---

## 2) สถานะปัจจุบันของโค้ด (Current State)

### 2.1 ส่วน fetch (god project)
- โฟลเดอร์ `god project/fetch/calendar/` มีไฟล์หลักอยู่แล้ว (`main.py`, `config.yaml`) แต่ยังว่าง (0 บรรทัด)
- ยังไม่พบโมดูล fetch สำหรับ `fred`, `mt5`, `cme fedwatch` ในโครงสร้างปัจจุบันของ `god project/fetch`

### 2.2 ส่วนเว็บ (god project)
- โปรเจคเว็บ `god project/web_trade-data-hub` ยังอยู่ในสถานะ starter template ของ Next.js
- หน้า `app/page.tsx` ยังเป็นหน้าเริ่มต้น (ไม่ได้แสดงข้อมูลเศรษฐกิจ/ตลาดตามเป้าหมาย)
- ยังไม่พบชั้นเชื่อมต่อฐานข้อมูล (เช่น neon client + query layer) หรือ API route สำหรับเสิร์ฟข้อมูล

### 2.3 ความพร้อมของ reference จากโปรเจคเก่า
- มี reference ที่นำกลับมาใช้ได้ทันที โดยเฉพาะ pipeline ของ calendar (`pipeline.py`, สคริปต์แยกขั้น, config)
- โค้ดเดิมมีการจัดโครงสร้างงาน fetch เป็น step ชัดเจน เหมาะกับการย้ายมาปรับใช้ใน god project

---

## 3) Gap Analysis (ช่องว่างระหว่างเป้าหมายกับสถานะปัจจุบัน)

### Gap A: Data Pipeline ยังไม่เกิดในโปรเจคใหม่
- เป้าหมายต้องรองรับหลาย source + หลายความถี่ แต่โค้ดปัจจุบันใน god project ยังไม่เริ่ม implement จริง
- ความเสี่ยง: ยังไม่สามารถสร้างข้อมูลกลางเพื่อให้เว็บ/โปรเจคอื่นใช้งานได้

### Gap B: Storage Layer / Data Contract ยังไม่ชัด
- เอกสารระบุว่าจะใช้ฐานข้อมูล (และเครื่องมือเว็บบอกถึง Neon) แต่ยังไม่เห็น schema/ตาราง/วิว/index/นโยบายการอัปเดตข้อมูล
- ความเสี่ยง: ต่อให้ fetch ได้แล้ว การ query/use ต่อจะไม่เสถียร

### Gap C: Frontend ยังไม่เชื่อมข้อมูลจริง
- เว็บยังเป็น template ไม่ได้มี dashboard/filters/tables/charts
- ความเสี่ยง: ไม่สามารถ validate คุณภาพข้อมูลผ่านการใช้งานจริง

### Gap D: Orchestration + Monitoring ยังไม่ครบ
- ยังไม่เห็น scheduler/workflow (cron/vercel cron/github actions) และระบบแจ้งเตือนสถานะงานในโปรเจคใหม่
- ความเสี่ยง: pipeline ขาดความต่อเนื่องในการรันจริง (production readiness ต่ำ)

---

## 4) การประเมินภาพรวม

**ระดับความพร้อมปัจจุบัน: 20/100 (ระยะตั้งต้น)**
- จุดแข็ง: เป้าหมายชัดเจน, มี reference ดีจากโปรเจคเก่าที่ reuse ได้
- จุดอ่อน: โค้ดใน god project ยังเป็น skeleton ทั้งฝั่ง fetch และ web
- ข้อสรุป: ต้องเร่งวาง “แกนกลางข้อมูล” (schema + ingest pipeline) ก่อนงาน UI

---

## 5) Roadmap ที่แนะนำ (เรียงตามลำดับสำคัญ)

### Phase 1 — Foundation (ต้องทำก่อน)
1. ออกแบบ schema กลางใน Neon
   - ตาราง raw/normalized/features แยกตามแหล่งข้อมูล
   - กำหนด unique key + upsert strategy + index ตาม query หลัก
2. สร้าง data contract
   - นิยามชื่อฟิลด์/ชนิดข้อมูล/หน่วยเวลา/timezone ให้ตรงกันทุก source
3. ย้าย Calendar pipeline จาก ref เข้าสู่ `god project/fetch/calendar`
   - เริ่มจาก weekly fetch + update actual ตามเอกสาร

### Phase 2 — Expand Sources
1. เติม pipeline สำหรับ FRED (daily/weekly/monthly)
2. เติม pipeline สำหรับ MT5 (ohlcv + features ที่ระบุ)
3. เติม pipeline สำหรับ CME FedWatch (probabilities + quotes)

### Phase 3 — Serve & Observe
1. เพิ่ม API/query layer สำหรับเว็บ
2. สร้างหน้า dashboard ใน Next.js (filters/timeframe/source)
3. ตั้ง scheduler + logging + alerting
4. เพิ่ม data quality checks (missing/outlier/staleness)

---

## 6) ข้อเสนอเชิงปฏิบัติ (สัปดาห์แรก)
1. คัดลอกโครง pipeline calendar จาก ref มา god project และปรับ path/config ให้รันได้
2. ตั้ง Neon schema รุ่นแรก (calendar_events + calendar_actual_updates)
3. ทำหน้าเว็บ MVP 1 หน้า: ตารางข่าวสัปดาห์นี้ + สถานะ actual
4. วาง cron รายสัปดาห์ + รอบอัปเดตระหว่างสัปดาห์

เมื่อ 4 ข้อนี้เสร็จ จะได้ “เส้นทางข้อมูลครบวงจร” ชุดแรก (fetch → db → web) เพื่อต่อยอด source อื่นเร็วขึ้น

---

## 7) อัปเดตหลังประเมิน
- สร้างไฟล์ `แผนการพัฒนาโครงการ.md` แล้ว โดยแปลงข้อเสนอเชิงกลยุทธ์ให้เป็นแผนปฏิบัติราย phase
- ลำดับปัจจุบันยังคงเริ่มจาก Foundation: schema + data contract + calendar pipeline


## 8) อัปเดตหลังรอบปรับแผนล่าสุด
- ปรับเอกสาร `แผนการพัฒนาโครงการ.md` ให้ลงรายละเอียดเชิงปฏิบัติ โดยระบุ Input/Output/Spec ของทุก data source ชัดเจน
- เพิ่ม acceptance criteria ราย phase เพื่อตรวจวัดความคืบหน้าแบบตรวจสอบได้
- เพิ่มข้อกำหนด schema/index/contract เพื่อปิดช่องว่างด้าน Data Contract และ Storage Layer ที่เคยระบุไว้ใน Gap Analysis

## 10) อัปเดตล่าสุด
- อัปเดตรอบ 2026-02-28 09:06 UTC: ทำงาน Phase 1 เรื่อง schema foundation แล้ว โดยเพิ่มไฟล์ migration `god project/neon/migrations/202602280001_schema_v1.sql` (มี `ops.pipeline_runs`, raw tables ของ Calendar/FRED/MT5/CME, feature tables, และ normalized latest views)

- อัปเดตรอบ 2026-02-28 09:10 UTC: ตรวจสอบ `202602280001_schema_v1.sql` เทียบแนวทางจาก ref แล้ว พบจุดเสี่ยงเรื่อง unique+NULL และ `updated_at_utc` ไม่อัปเดตเอง จึงปรับ migration ให้ idempotent และปลอดภัยขึ้นสำหรับ rerun/upsert

## 11) อัปเดตล่าสุด
- อัปเดตรอบ 2026-02-28 09:46 UTC: ดำเนินงานฝั่ง Web MVP โดยพัฒนาหน้า `god project/web_trade-data-hub/app/page.tsx` ให้มี Calendar Section แล้ว (hero + summary cards + upcoming events table) แทนหน้า starter เดิม
- สถานะ: เริ่มต้น Phase 3 (Web & API) ในส่วน UI โครงสร้างหน้า Calendar ก่อนเชื่อม query layer จาก Neon
- งานถัดไปที่แนะนำ: แทนที่ข้อมูล mock ด้วย query จาก `normalized.calendar_events_latest` และเพิ่ม filter (`from/to`, `currency`, `impact`) ตาม API contract

## 12) อัปเดตล่าสุด
- อัปเดตรอบ 2026-02-28 09:52 UTC: ปิดช่องว่างสำคัญฝั่ง Calendar ingest แล้ว โดยเพิ่มโค้ดใน `god project/fetch/calendar/main.py` ให้ทำงานครบ fetch -> normalize -> upsert DB
- เพิ่มการเขียน run log เข้า `ops.pipeline_runs` ตั้งแต่สถานะ `running` และปิดเป็น `success/failed` เมื่อจบงาน
- สถานะความพร้อม: ส่วน Calendar pipeline ขยับจาก skeleton ไปเป็น executable pipeline แล้ว เหลืองานผูก scheduler/secret จริงและทดสอบกับ Neon environment จริง

## 13) อัปเดตล่าสุด (การแก้ปัญหาใช้งานจริง)
- อัปเดตรอบ 2026-02-28 10:02 UTC: แก้ defect สำคัญด้าน usability ของคำสั่ง `python god_project/fetch/calendar/main.py`
- เดิม: default `--config config.yaml` อ้างอิง CWD ทำให้รันจาก root repo แล้ว error `[Errno 2] No such file or directory: 'config.yaml'`
- ปัจจุบัน: เพิ่ม fallback ให้ resolve ไปที่โฟลเดอร์เดียวกับ `main.py` อัตโนมัติ จึงรันจาก root ได้โดยไม่ต้องส่ง `--config` เพิ่ม
- ผลกระทบ: ลด friction การใช้งาน/ตั้ง scheduler และลดความเสี่ยง human error เวลาเรียก pipeline

## 16) บันทึกความคืบหน้าเพิ่มเติม (2026-02-28 10:29 UTC)
- [x] แก้ pain point การตั้งค่า Neon credential ของ Calendar pipeline
  - เพิ่มตัวอ่าน `.env`/`.env.local` แบบไม่ทับค่าที่มีอยู่ใน process env
  - เพิ่ม fallback ลำดับการอ่าน URL/Key ให้รองรับทั้งตัวแปรฝั่ง backend และตัวแปรที่มักมีใน Next.js (`NEXT_PUBLIC_*`)
- ผลลัพธ์: ลด error `Missing Neon URL/API key in env or config` สำหรับการรันคำสั่งจาก root โปรเจคหรือจากเครื่อง developer ที่เก็บค่าบนไฟล์ env
- งานต่อเนื่อง: แนะนำใช้ `NEON_SERVICE_ROLE_KEY` ใน production เพื่อสิทธิ์ write ที่ถูกต้อง แทน anon key

## 16) บันทึกความคืบหน้าเพิ่มเติม (2026-02-28 10:38 UTC)
- [x] ลด friction ตอนรัน local ของ Calendar pipeline
  - แก้ที่ `god_project/fetch/calendar/main.py` ให้ค่าเริ่มต้น skip ขั้นตอนเขียนฐานข้อมูลเมื่อไม่พบ Neon credentials (แสดง WARN แทน error)
  - เพิ่ม flag `--require-db` เพื่อให้ behavior แบบ strict สำหรับ production
- [x] ทดสอบพฤติกรรม 2 กรณี
  - ไม่มี credentials + โหมด default => exit 0 พร้อม WARN
  - ไม่มี credentials + `--require-db` => exit 1 พร้อมข้อความ Missing Neon URL/API key

## 17) บันทึกวิเคราะห์ปัญหา runtime (2026-02-28 10:55 UTC)
- ตรวจ log ที่ผู้ใช้รายงาน: `Fetched items=85 normalized=85` + `WARN: Missing Neon URL/API key in env or config, skip database write`
- ข้อสรุป:
  - ขั้นตอน fetch และ normalize ผ่านแล้ว (ไม่มี error ด้านแหล่งข้อมูล)
  - จุดที่ยังไม่ผ่านคือขั้นตอนเขียน Neon เพราะไม่พบ `NEON_URL` หรือ key สำหรับ write ตาม fallback ที่ระบบรองรับ
  - พฤติกรรมนี้เป็น design ของโหมด default เพื่อให้ local dev รันต่อได้โดยไม่ fail hard
- คำแนะนำใช้งาน:
  - ถ้าต้องการเขียน DB ให้ตั้ง `NEON_URL` + `NEON_SERVICE_ROLE_KEY` (หรือ key fallback ที่รองรับ)
  - ถ้าต้องการให้ job fail ทันทีเมื่อ secret หาย ให้รันพร้อม `--require-db`

## 18) บันทึกการแก้ข้อสงสัยเรื่อง `neon.env` (2026-02-28 11:10 UTC)
- ปรับโค้ดแล้ว: Calendar pipeline จะพยายามโหลด `god_project/fetch/neon.env` ในช่วง hydrate env
- ผลเชิงพฤติกรรม: หากมีค่า `NEON_URL`/`NEON_SERVICE_ROLE_KEY` (หรือ fallback key) อยู่ในไฟล์ดังกล่าว ระบบจะนำไปใช้ต่อในขั้นตอนเขียน DB ได้
- หมายเหตุ: ไฟล์ตัวอย่างปัจจุบันยังเป็นค่าว่าง จึงยังเกิด WARN ได้จนกว่าจะเติมค่าจริง
## 19) อัปเดตการเปลี่ยนฐานข้อมูลอ้างอิงเป็น Neon (2026-02-28 11:40 UTC)
- ปรับถ้อยคำในเอกสารประเมินที่เกี่ยวข้องทั้งหมดให้ใช้อ้างอิง Neon แทนชื่อเดิม
- ปรับคำแนะนำเชิงปฏิบัติสำหรับ credentials/env และ query layer ให้สอดคล้องกับ Neon
- ผลกระทบ: baseline การประเมินและแผนต่อเนื่องตรงกับทิศทางเทคโนโลยีปัจจุบันของโปรเจค
